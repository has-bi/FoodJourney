generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id          String   @id @default(uuid())
  username    String   @unique @db.VarChar(20)
  displayName String   @map("display_name") @db.VarChar(50)
  color       String   @db.VarChar(7)
  createdAt   DateTime @default(now()) @map("created_at")

  places Place[]

  @@map("users")
}

model Place {
  id        String        @id @default(uuid())
  name      String        @db.VarChar(200)
  mapsLink  String        @map("maps_link")
  category  PlaceCategory

  // Basic info from Gemini
  cuisine   String?       @db.VarChar(100)
  area      String?       @db.VarChar(100) // e.g., "Bintaro", "Senayan"

  // Pricing
  priceRangeText  String?   @map("price_range_text") @db.VarChar(50) // "50-100k IDR"
  priceCategory   String?   @map("price_category") @db.VarChar(20) // budget/moderate/expensive/premium

  // Menu - stored as JSON
  signatureMenus  Json?     @map("signature_menus") // [{name, price}]

  // Quality indicators
  googleRating    Float?    @map("google_rating")
  reviewCount     Int?      @map("review_count")

  // Practical info
  commonComplaint String?   @map("common_complaint")
  waitTime        String?   @map("wait_time") @db.VarChar(200)
  parkingInfo     String?   @map("parking_info") @db.VarChar(200)
  operatingHours  String?   @map("operating_hours") @db.VarChar(200)

  // AI confidence
  aiConfidence    String?   @map("ai_confidence") @db.VarChar(10) // high/medium/low

  // Metadata
  addedBy   User     @relation(fields: [addedById], references: [id])
  addedById String   @map("added_by")
  addedAt   DateTime @default(now()) @map("added_at")
  status    PlaceStatus @default(suggested)

  // Approval
  hasbiApproved Boolean @default(false) @map("hasbi_approved")
  nadyaApproved Boolean @default(false) @map("nadya_approved")

  // Notes when suggesting
  suggestedNotes String? @map("suggested_notes")

  // Visit type - solo or together
  visitType     VisitType @default(together) @map("visit_type")
  inviteStatus  InviteStatus? @map("invite_status") // For together visits

  // Preference tags - stored as JSON array
  // e.g., ["birthday", "rainy_day", "hungry_af", "comfort_food"]
  tags          Json?     @map("tags")

  // Legacy fields (kept for backward compatibility, will migrate to Visit model)
  // After visit - DEPRECATED: use visits relation instead
  visitedAt DateTime? @map("visited_at")
  photoUrl  String?   @map("photo_url")

  // Hasbi's review - DEPRECATED: use visits relation instead
  hasbiRating Int?    @map("hasbi_rating")
  hasbiNotes  String? @map("hasbi_notes")
  hasbiReviewedAt DateTime? @map("hasbi_reviewed_at")

  // Nadya's review - DEPRECATED: use visits relation instead
  nadyaRating Int?    @map("nadya_rating")
  nadyaNotes  String? @map("nadya_notes")
  nadyaReviewedAt DateTime? @map("nadya_reviewed_at")

  // Visits - multiple visits per place
  visits    Visit[]

  // Computed/cached stats (updated when visits change)
  visitCount    Int @default(0) @map("visit_count")
  avgHasbiRating Float? @map("avg_hasbi_rating")
  avgNadyaRating Float? @map("avg_nadya_rating")
  lastVisitedAt DateTime? @map("last_visited_at")

  // Content tracking (Hasbi only)
  hasbiContentCreated Boolean @default(false) @map("hasbi_content_created")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([addedById])
  @@index([category])
  @@index([lastVisitedAt(sort: Desc)])
  @@map("places")
}

model Visit {
  id        String    @id @default(uuid())
  place     Place     @relation(fields: [placeId], references: [id], onDelete: Cascade)
  placeId   String    @map("place_id")

  // Visit info
  visitedAt DateTime  @map("visited_at")
  photoUrl  String?   @map("photo_url") // legacy â€“ kept for backward compat
  visitType VisitType @default(together) @map("visit_type")

  // What we ordered - stored as JSON array
  // e.g., [{name: "Nasi Goreng", notes: "Enak banget!"}]
  orderedItems Json?   @map("ordered_items")

  // Hasbi's review
  hasbiRating    Int?      @map("hasbi_rating")
  hasbiNotes     String?   @map("hasbi_notes")
  hasbiPhotoUrl  String?   @map("hasbi_photo_url")
  hasbiReviewedAt DateTime? @map("hasbi_reviewed_at")

  // Nadya's review
  nadyaRating    Int?      @map("nadya_rating")
  nadyaNotes     String?   @map("nadya_notes")
  nadyaPhotoUrl  String?   @map("nadya_photo_url")
  nadyaReviewedAt DateTime? @map("nadya_reviewed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([placeId])
  @@index([visitedAt(sort: Desc)])
  @@map("visits")
}

model AppConfig {
  id        String   @id @default(uuid())
  key       String   @unique @db.VarChar(50)
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("app_config")
}

model LoveVoucherRedemption {
  id                String   @id @default(uuid())
  voucherId         String   @map("voucher_id") @db.VarChar(50)
  voucherTitle      String   @map("voucher_title") @db.VarChar(200)
  voucherDescription String  @map("voucher_description") @db.VarChar(300)
  monthKey          String   @map("month_key") @db.VarChar(7) // YYYY-MM in Asia/Jakarta
  redeemedBy        String   @map("redeemed_by") @db.VarChar(20) // "nadya"
  redeemedAt        DateTime @default(now()) @map("redeemed_at")

  @@unique([voucherId])
  @@unique([redeemedBy, monthKey], name: "redeemerMonthKey")
  @@index([redeemedBy])
  @@index([redeemedAt(sort: Desc)])
  @@map("love_voucher_redemptions")
}

enum PlaceStatus {
  suggested
  planned
  archived
  skipped
}

enum PlaceCategory {
  cafe
  resto
  sushi
  fine_dining
  street_food
  dessert
}

enum VisitType {
  solo
  together
}

enum InviteStatus {
  pending
  accepted
  declined
}
